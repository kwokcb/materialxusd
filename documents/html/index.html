<!-- HTML header for doxygen 1.12.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MaterialXUSD: MaterialX USD Utilities</title>
<link rel="icon" href="toon_sphere.png" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<!-- Font Awesome CDN -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="MX_LAB.svg" style="width: 48px"/></td>
  <td id="projectalign">
   <div id="projectname">MaterialXUSD<span id="projectnumber">&#160;0.25.05</span>
   </div>
   <div id="projectbrief">Utilities for using MaterialX with USD</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('index.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">MaterialX USD Utilities </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__d_1_2_work_2materialx_2materialxusd_2_r_e_a_d_m_e"></a></p>
<p><a href="https://github.com/kwokcb/materialxusd/actions"><img src="https://github.com/kwokcb/materialxusd/actions/workflows/static.yml/badge.svg" alt="GitHub Actions Status" style="pointer-events: none;" class="inline"/> </a></p>
<p>This is a Github <a href="https://github.com/kwokcb/materialxusd">repository</a> of utilities related to MaterialX and USD.</p><ul>
<li>The web site can be found <a href="https://kwokcb.github.io/materialxusd/">here</a></li>
<li>The <code>PyPi</code> package can be found <a href="https://pypi.org/project/materialxusd/" target="_blank">here</a>.</li>
<li>The utilities and results currently use the <code>25.05</code> version of OpenUSD which is sync'ed to MaterialX version <code>1.39.3</code>.</li>
</ul>
<p>This can be hooked into the larger interoperability picture with glTF / MaterialX and USD as shown in the example below:</p>
<p><img src="https://kwokcb.github.io/materialxusd/documents/results/usd_gltf_mtlx_desk_web.png" alt="" width="100%" class="inline"/></p>
<blockquote class="doxtable">
<p>&zwj;Figure: MaterialX material from <a href="https://matlib.gpuopen.com/main/materials/all?search=TH%20Cath&amp;material=6e933741-eeb3-4956-b756-0b44f08aa6cf">AMD GPUOpen library</a>. Converted to USD and displayed in <code>usdview</code> (top left), converted to glTF and display in ThreeJS editor (top right). Display in MaterialX Viewer (bottom left), and Web editor (bottom right) </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md1"></a>
Available Components</h2>
<ul>
<li><code><a class="el" href="mtlxdownload_8py.html" title="MaterialX release downloader command for fetching releases and libraries from GitHub.">mtlxdownload.py</a></code> : Utility to download releases or source folders (such as libraries, or resources) from MaterialX.</li>
<li><p class="startli"><code><a class="el" href="mtlx2usd_8py_source.html">mtlx2usd.py</a></code> : Utility which takes a MaterialX document and creates a corresponding USD document with scene geometry, lights, and camera.</p>
<p class="startli">The main intent is currently to be able to consume documents from the MaterialX render test suite but any MaterialX file can be used as input.</p>
</li>
<li>Options Include:<ul>
<li>Preprocess the MaterialX file to attempt to produce valid USD shading network (See Support Utilities)</li>
<li>Input geometry (USD file)</li>
<li>Input camera (USD file)</li>
<li>Skydome light (A latlong HDR file)</li>
<li>Perform USD validation</li>
<li>Export just the materials to a USD file.</li>
<li>Render the corresponding USD file. This uses <code>usdrecord</code> currently. Render arguments can be passed in to specify the render delegate to use for instance. The default is GL.</li>
<li>Misc options for output for test suite compatibility:<ul>
<li>Use material name for file name</li>
<li>Create in subfolder with name being the input MaterialX name</li>
</ul>
</li>
</ul>
</li>
<li>Preprocessing Utilities:<ul>
<li><code><a class="el" href="preprocess__mtlx_8py_source.html">preprocess_mtlx.py</a></code> : Tries to preprocess a MaterialX document so that it considered valid by USD. Currently this includes logic to:<ul>
<li>Encapsulate <b>top level nodes</b> in a MaterialX document into a nodegraph but preserve connections. Only materials and shading model nodes are valid at the top level in USD.</li>
<li>Resolve any <b>implicit geometry stream bindings</b> on <code>inputs</code> and make them explicit by adding geometric stream nodes and binding them to any inputs with implicit bindings. Note that this requires loading in the standard library to get node definitions.</li>
<li>Add a <b>material node per surface shader</b> which is not connected to any downstream material. USD only examines materials and not shaders so these shaders are skipped during conversion.</li>
<li>Extract out any surface shaders inside a nodegraph to be outside the graph as this is considered invalid by USD.</li>
<li>If a surface shader input is connected to a nodegraph, add in an <b>explicit <code>output</code> qualifier</b>. Seems <code>out</code> is assumed to be the name of the output when there is no explicit qualifier which can be incorrect.</li>
<li><b>"Flatten" (resolve) all image asset references</b> using the existing MaterialX utilities for path resolve. This is needed as the MaterialX render tests have assumed search paths which are not explicitly defined &ndash; thus requiring the paths to be passed in as part of preprocessing.<ul>
<li>There is probably a better way to do this using USD asset resolvers, but have not tried. ( Input is welcome on this. )</li>
</ul>
</li>
<li>Remove any <code>value</code> attributes on <code>input</code>s with connections to avoid ambiguity and MaterialX validation errors.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md2"></a>
Issues</h2>
<p>Issue logging is being tracked under these "master" issues:</p><ul>
<li><a href="https://github.com/AcademySoftwareFoundation/MaterialX/issues/2291">MaterialX</a></li>
<li><a href="https://github.com/PixarAnimationStudios/OpenUSD/issues/3571">OpenUSD</a></li>
</ul>
<details >
<summary >
Notes</summary>
<p></p>
<ul>
<li>Color space and Real World Units:<ul>
<li>Color space meta-data appears to work properly as do explicit color space conversion nodes. <br  />
</li>
<li><b>Real world unit meta-data is lost during conversion</b>. Unknown if this is unsupportable or a known issue.</li>
</ul>
</li>
<li>There appears to be no way to convert shading graphs which have a roots surface shaders which are not the current shading models: glTF, USDPreviewSurface, OpenPBR ? That is arbitrary PBR shaders. They may translate but are considered invalid root nodes. <b>It is unclear / undocumented as to what are "valid" root pbr nodes for USD.</b></li>
<li><b>Nodes graphs with child nodes that are the same name as the parent graph</b>, and which are connected will be interpreted improperly by USD as it attempts to connect the incorrect upstream path and returns an error on conversion from MaterialX to USD. These tests have been manually modified for nowt to rename the interior node. This appears to be a USD logic error.</li>
<li><b>Validation is inconsistent between USD and MaterialX for upstream output connections</b>. If the upstream node / nodegraph has 1 connection then a validation warning is issues if you explicit specify that output. If you do not specify the output then conversion to USD will skip this link. <em>It would be useful to remove this inconsistent validation check in MaterialX.</em></li>
<li><code>usdMtlx</code> always tries to add in a <code>NodeGraphs</code> scope but this does not necessary contain graphs but nodes which can get confusing. Additionally downstrem port connects are incorrect as the first node's output seems to always be used.</li>
<li>In generate <code>usdMtlx</code> seems to set up incorrect upstream connections for multiple output (<code>multioutput</code>) nodes and nodegraphs, assuming to take the first output and assuming the name <code>out</code> as opposed to taking the first (compatible) output which is done in MaterialX. <b>Connection failures result in aborting conversion completely</b> (instead of converting but leaving out certain connections) <br  />
</li>
<li>For rendering HDStorm and the default (GLSL/ OSL / MDL) MaterialX renderers use different sampling logic for environment lighting. e.g. Anisotropy differs.</li>
<li>For render results: The rendering setup for translucent / transparent shading does not show the environment when it is set to be hidden. There is probably a way to make this show up while hiding the background. <b>Input is welcome on this</b>. </li>
</ul>
</details>
<h1><a class="anchor" id="autotoc_md3"></a>
Usage</h1>
<h2><a class="anchor" id="autotoc_md4"></a>
Installation and Usage</h2>
<p>Install from the root folder:</p>
<div class="fragment"><div class="line">pip install .</div>
</div><!-- fragment --><p> or install from <code>PyPi</code> </p><div class="fragment"><div class="line">pip install materialxusd</div>
</div><!-- fragment --><p>Run using the <code>materialxusd</code> command. Currently there are two commands for:</p><ul>
<li>MaterialX to USD conversion which can be run using</li>
</ul>
<div class="fragment"><div class="line">materialxusd m2u</div>
</div><!-- fragment --><p> and preprocessing MaterialX documents which can be run using</p>
<div class="fragment"><div class="line">materialxusd pmtlx</div>
</div><!-- fragment --><p>The <code>tests</code> folder has a script with some command line calls to process an examples subfolder (<code>run_examples.sh</code>)</p>
<div class="fragment"><div class="line">echo Convert sample MaterialX files to USD and render</div>
<div class="line">materialxusd m2u -pp -v -sf -mn ./examples/no_materials.mtlx </div>
<div class="line">materialxusd m2u -pp -v -f -sf -mn -r -m ./examples/standard_surface_carpaint.sphere.mtlx </div>
<div class="line">materialxusd m2u -pp -v -sf -mn -r -m ./examples/standard_surface_marble_solid.mtlx </div>
<div class="line">materialxusd m2u -pp -v -sf -mn -r -m ./examples/linepattern.mtlx </div>
<div class="line">echo Preprocess and convert sample MaterialX files to USD</div>
<div class="line">materialxusd pmtlx ./examples/linepattern_orig.mtlx</div>
<div class="line">materialxusd m2u -pp -v -sf -mn -r -m ./examples/linepattern_orig_converted.mtlx</div>
<div class="line">echo Convert ZIP file </div>
<div class="line">materialxusd m2u -pp -v -sf -mn -r -m ./examples/TH_Cathedral_Floor_Tiles_1k_8b_JRHrQHt.zip</div>
</div><!-- fragment --><p>Some rendering of resulting USD files are shown below:</p>
<hr  />
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Material   </th><th class="markdownTableHeadCenter">Pre-processing Required   </th><th class="markdownTableHeadCenter">USD Rendering    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Line Pattern   </td><td class="markdownTableBodyCenter">Generate Materials for outputs on NodeGraph   </td><td class="markdownTableBodyCenter"><img src="https://raw.githubusercontent.com/kwokcb/materialxusd/refs/heads/main/tests/examples/linepattern/test_crosshatch_glslfx.png" alt="" width="128px" class="inline"/>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">Marble   </td><td class="markdownTableBodyCenter">Add downstream material + explicit stream bindings   </td><td class="markdownTableBodyCenter"><img src="https://raw.githubusercontent.com/kwokcb/materialxusd/refs/heads/main/tests/examples/standard_surface_marble_solid/Marble_3D_glslfx.png" alt="" width="128px" class="inline"/>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Car Paint   </td><td class="markdownTableBodyCenter">Add downstream material   </td><td class="markdownTableBodyCenter"><img src="https://raw.githubusercontent.com/kwokcb/materialxusd/refs/heads/main/tests/examples/standard_surface_carpaint.sphere/Car_Paint_glslfx.png" alt="" width="128px" class="inline"/>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">AMD GPUOpen Wood (Zip)   </td><td class="markdownTableBodyCenter">Unzip and resolve asset paths   </td><td class="markdownTableBodyCenter"><img src="https://raw.githubusercontent.com/kwokcb/materialxusd/refs/heads/main/tests/examples/TH_Cathedral_Floor_Tiles_1k_8b_JRHrQHt/TH_Cathedral_Floor_Tiles/TH_Cathedral_Floor_Tiles_glslfx.png" alt="" width="128px" class="inline"/>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Adobe pattern   </td><td class="markdownTableBodyCenter">Wrap top level nodes, create explicit output port connections   </td><td class="markdownTableBodyCenter"><img src="https://raw.githubusercontent.com/kwokcb/materialxusd/refs/heads/main/tests/examples/parquet_clothes/parquet_clothes/surfacematerial_glslfx.png" alt="" width="128px" class="inline"/>   </td></tr>
</table>
<hr  />
<p>There is additionally a sample script that will traverse a local copy of the MaterialX test suite (<code>render_rts.sh</code>). The script calls the package's Python commands directly.</p>
<div class="fragment"><div class="line">folders=(</div>
<div class="line">    &quot;./resources/Materials/Examples&quot;</div>
<div class="line">    &quot;./resources/Materials/TestSuite/stdlib/convolution&quot;</div>
<div class="line">    &quot;./resources/Materials/TestSuite/stdlib/color_management&quot;</div>
<div class="line">    &quot;./resources/Materials/TestSuite/stdlib/procedural&quot;</div>
<div class="line">    &quot;./resources/Materials/TestSuite/pbrlib/surfaceshader&quot;</div>
<div class="line">    &quot;./resources/Materials/TestSuite/nprlib&quot;</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">for folder in &quot;${folders[@]}&quot;; do</div>
<div class="line">    echo &quot;Rendering $folder&quot;</div>
<div class="line">    python ../source/materialxusd/mtlx2usd.py -pp -mn -sf &quot;$folder&quot; -r -g ./data/sphere.usd -c ./data/camera_sphere.usda -e ./data/san_giuseppe_bridge.hdr</div>
<div class="line">done</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md7"></a>
Documentation</h2>
<p>An overview MaterialX-&gt;USD presentation can be found <a href="https://kwokcb.github.io/materialxusd/documents/results/MaterialX_USD_WG_Presentation_March_12_2025.pdf"><img src="https://kwokcb.github.io/materialxusd/documents/results/MaterialX_USD_WG_Presentation_March_12_2025.png" alt="" width="100%" class="inline"/>here</a></p>
<p>Python API documentation can be found <a href="https://kwokcb.github.io/materialxusd/documents/html/index.html">here</a> </p>
<h1><a class="anchor" id="autotoc_md8"></a>
Acceptance</h1>
<p>An initial acceptance criteria is to be able to run MaterialX to USD conversion against the MaterialX render test suite files. Preliminary results are show below:</p>
<h2><a class="anchor" id="autotoc_md9"></a>
Gallery of Example Materials</h2>
<h3><a class="anchor" id="autotoc_md10"></a>
Render Test Suite material Renderings</h3>
<p><a href="https://kwokcb.github.io/materialxusd/tests/usd_mtlx_image_gallery.html" target="_blank"><img src="https://kwokcb.github.io/materialxusd/documents/images/rts_gallery.png" alt="USD RTS image gallery" width="100%" class="inline"/> </a></p>
<h3><a class="anchor" id="autotoc_md11"></a>
Unit Test Renderings</h3>
<p><a href="https://kwokcb.github.io/materialxusd/tests/unit_test_gallery.html" target="_blank" target="_blank"><img src="https://kwokcb.github.io/materialxusd/documents/images/unit_test_gallery.png" alt="Unit test image gallery" width="100%" class="inline"/> </a></p>
<h3><a class="anchor" id="autotoc_md12"></a>
<a href="https://physicallybased.info/" target="_blank">Physically Based Material Library</a> Renderings</h3>
<p><a href="https://kwokcb.github.io/materialxusd//tests/usd_physically_based_gallery.html" target="_blank"><img src="https://kwokcb.github.io/materialxusd/documents/images/physicallyBased_gallery.png" alt="USD RTS image gallery" width="100%" class="inline"/> </a></p>
<h2><a class="anchor" id="autotoc_md13"></a>
Comparison: GLSL vs GLSLFX</h2>
<p><a href="https://kwokcb.github.io/materialxusd/tests/glsl_vs_glslfx.html" target="_blank"><img src="https://kwokcb.github.io/materialxusd/documents/images/glsl_vs_glsfx.png" alt="GLSL vs GLSLFx image comparison" width="100%" class="inline"/> </a></p>
<h2><a class="anchor" id="autotoc_md14"></a>
Comparison: GLSL vs OSL vs GLSLFX</h2>
<p><a href="https://kwokcb.github.io/materialxusd/tests/glsl_vs_osl_glslfx.html" target="_blank"><img src="https://kwokcb.github.io/materialxusd/documents/images/glsl_vs_glsfx_vs_osl.png" alt="GLSL vs GLSLFx image comparison" width="100%" class="inline"/> </a></p>
<h1><a class="anchor" id="autotoc_md15"></a>
Design</h1>
<p>An overview of the current package design is shown below. Boxes / lines which are dotted are optional logic which may be executed as desired.</p>
<p><img src="https://kwokcb.github.io/materialxusd/documents/images/design.png" alt="" width="100%" class="inline"/> </p>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.12.0-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li>
      <button class="btn btn-outline" type="button">
        <a href="https://github.com/kwokcb/materialxusd" target="_blank"><b class="fa-brands fa-github fa-1x"
            style="color: #ffffff;"></b></a>
      </button>
      <button class="btn btn-outline " type="button">
        <a href="https://www.linkedin.com/in/bernard-kwok/" target="_blank"><b class="fa-brands fa-linkedin-in fa-1x"
            style="color: #0082ca;"></b></a>
      </button>
    </li>
    <li><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
        <img alt="Creative Commons License" style="border-width:0; width: 48px"
          src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />
    </li>
    </a>
    <li><a href="https://kwokcb.github.io/nanmuconsulting/" target="_blank" style="color: #333; text-decoration: none;">
        &copy; 2022-2025 NanMu Consulting.
      </a>
    </li>
  </ul>
</div>
<!-- Bootstrap JS (Optional) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
